image: python:latest

# Change pip's cache directory to be inside the project directory since we can
# only cache local items.
variables:
  PIP_CACHE_DIR: "$CI_PROJECT_DIR/.cache/pip"
  CI_AWS_CF_CREATE_STACK_FILE: 'aws/cf_create_stack.json'
  CI_AWS_S3_PUSH_FILE: 'aws/s3_push.json'
  CI_AWS_EC2_DEPLOYMENT_FILE: 'aws/create_deployment.json'
  CI_AWS_CF_STACK_NAME: 'larks_final_project'

include:
  - template: AWS/CF-Provision-and-Deploy-EC2.gitlab-ci.yml

# Pip's cache doesn't store the python packages
# https://pip.pypa.io/en/stable/topics/caching/
#
# If you want to also cache the installed packages, you have to install
# them in a virtualenv and cache it as well.
cache:
  paths:
    - .cache/pip
    - venv/

stages:
    - build
    - static analysis
    - test
    - deploy


before_script:
  - python --version  # For debugging
  - pip install virtualenv
  - virtualenv venv
  - source venv/bin/activate
  - pip install -r requirements.txt


lint:
  stage: static analysis
  allow_failure: true
  image: registry.gitlab.com/mafda/python-linting
  script: 
    - python -m flake8 .
  only:
    - merge_requests


unit_tests:
  stage:
    - test
  script:
     - python -m pytest -v -m unit

functional_tests:
  stage:
    - test
  script:
     - python -m pytest -v -m unit


deploy:
  stage: deploy
  only: master
  script: echo "Define your deployment script!"
  environment: production
